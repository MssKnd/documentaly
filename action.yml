name: documentaly
author: mssknd
description: Check document maintenance
branding:
  icon: file-text
  color: orange
inputs:
  GITHUB_TOKEN:
    # description: 'ex. ${{ secrets.GITHUB_TOKEN }}'
    required: true
  BASE_BRANCH:
    description: 'Base branch name (default: main)'
    default: 'main'
runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v1.x
    - name: Fetch base branch
      shell: bash
      run: git fetch origin ${{ inputs.BASE_BRANCH }}:${{ inputs.BASE_BRANCH }}
    - name: Check to maintain documents
      id: check
      shell: bash
      run: >
        deno run -A
        https://deno.land/x/documentaly/main.ts check
        -t ${{ inputs.BASE_BRANCH }}
        >> ./dipendency.json
    - name: debug
      shell: bash
      run: cat dipendency.json
    - name: Generate comment body file
      shell: bash
      env:
        PR_HEAD_SHA: ${{github.event.pull_request.head.sha}}
        PR_HEAD_FULL_NAME: ${{github.event.pull_request.head.repo.full_name}}
      run: >
        deno run -A
        https://deno.land/x/documentaly/main.ts comment
        -b ${PR_HEAD_FULL_NAME}
        -s ${PR_HEAD_SHA}
        -j "./dipendency.json"
        >> comment-body.txt
    - name: Make comment on pull request when this action was pull request event.
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.pull_request.number }}      
      shell: bash
      run: >
        if [ -n "${PR_NUMBER}" ]; then
          gh pr comment ${PR_NUMBER} -F ./comment-body.txt
        fi
